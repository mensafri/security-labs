<?php
session_start();
$base_path = '../../';
include '../../db.php';

// Logic for Scope Generator
$generated_doc = "";
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $client = $_POST['client'];
    $scope_type = $_POST['scope_type']; // Blackbox, Whitebox, Greybox
    $allowed = isset($_POST['allowed']) ? $_POST['allowed'] : [];
    $forbidden = isset($_POST['forbidden']) ? $_POST['forbidden'] : [];
    
    // Evaluation Logic
    $score = 0;
    $feedback = "";
    
    if (in_array('dos', $allowed)) {
        $feedback .= "âŒ BAHAYA: Denial of Service (DoS) biasanya DILARANG dalam pentest production karena bisa mematikan bisnis.<br>";
    } else {
        $score += 20;
    }
    
    if (in_array('admin_panel', $forbidden) && $scope_type == 'Whitebox') {
        $feedback .= "âš ï¸ Warning: Whitebox testing biasanya membutuhkan akses penuh, termasuk Admin Panel.<br>";
    } else {
        $score += 20;
    }

    if (empty($allowed)) {
        $feedback .= "âŒ Error: Anda belum menentukan apa yang boleh dites.<br>";
    } else {
        $score += 10;
    }
    
    $generated_doc = true;
}

if (!isset($_SESSION['user_id'])) {
    header("Location: ../../login.php");
    exit;
}

include '../../includes/header.php';
?>

<div class="card">
    <div class="module-header" style="background: linear-gradient(135deg, #1e1b4b, #312e81);">
        <h1>ğŸ•µï¸ Modul 8: Penetration Testing Methodology</h1>
        <p><strong>Phase 1: Pre-Engagement.</strong> Sebelum menyentuh terminal, hacker profesional harus memiliki izin legal.</p>
    </div>

    <!-- Educational Context -->
    <div class="alert alert-info" style="border-left: 4px solid #6366f1;">
        <h3>ğŸ¤” Mengapa ini "Cyber Security"?</h3>
        <p>Banyak pemula mengira cyber security hanya tentang koding dan tools.</p>
        <p><strong>Fakta:</strong> Perbedaan hacker legal (White Hat) dan kriminal (Black Hat) HANYA ada di selembar kertas ini.</p>
        <p>Tanpa <strong>Rules of Engagement (RoE)</strong>, aktivitas Anda adalah ilegal dan bisa dipidana UU ITE. Modul ini melatih Anda menjadi <strong>Profesional</strong>, bukan sekedar Script Kiddie.</p>
    </div>

    <div class="grid-2">
        <!-- Input Form -->
        <div>
            <h3>ğŸ“ Draft Rules of Engagement (RoE)</h3>
            <p>Klien: <strong>PT. Maju Mundur Tech</strong></p>
            <form method="POST">
                <input type="hidden" name="client" value="PT. Maju Mundur Tech">
                
                <div style="margin-bottom: 1rem;">
                    <label>Metode Testing</label>
                    <select name="scope_type" class="btn btn-secondary" style="width:100%">
                        <option value="Blackbox">Blackbox (Tanpa informasi internal)</option>
                        <option value="Greybox">Greybox (Informasi parsial/user)</option>
                        <option value="Whitebox">Whitebox (Full source code access)</option>
                    </select>
                </div>

                <div class="checkbox-group" style="margin-bottom: 1rem;">
                    <label style="font-weight: bold; border:none; padding:0; background:none;">âœ… Diizinkan (In-Scope)</label>
                    <label><input type="checkbox" name="allowed[]" value="web_app" checked> Web Application (Port 80/443)</label>
                    <label><input type="checkbox" name="allowed[]" value="api"> API Endpoints</label>
                    <label><input type="checkbox" name="allowed[]" value="social_eng"> Social Engineering (Phishing Karyawan)</label>
                    <label><input type="checkbox" name="allowed[]" value="dos"> Denial of Service (DoS) <span style="color:red; margin-left:auto;">(Hati-hati!)</span></label>
                </div>

                <div class="checkbox-group" style="margin-bottom: 1rem;">
                    <label style="font-weight: bold; border:none; padding:0; background:none;">ğŸš« Dilarang (Out-of-Scope)</label>
                    <label><input type="checkbox" name="forbidden[]" value="dos" checked> Denial of Service (DoS)</label>
                    <label><input type="checkbox" name="forbidden[]" value="physical"> Physical Intrusion (Masuk kantor)</label>
                    <label><input type="checkbox" name="forbidden[]" value="production_db"> Delete Production Data</label>
                </div>

                <button type="submit" class="btn" style="width:100%">ğŸ“„ Generate Dokumen Kontrak</button>
            </form>
        </div>

        <!-- Feedback & Preview -->
        <div>
            <?php if ($generated_doc): ?>
                <h3>ğŸ“‘ Hasil Review Dokumen</h3>
                <?php if ($feedback): ?>
                    <div class="alert alert-error">
                        <?= $feedback ?>
                    </div>
                    <p>Silakan perbaiki pilihan Anda berdasarkan standar etika Pentest.</p>
                <?php else: ?>
                    <div class="alert alert-success">
                        <strong>âœ… Sempurna!</strong> Scope yang Anda buat aman dan profesional.
                    </div>
                    
                    <div class="paper-doc">
                        <h2 style="text-align: center; text-decoration: underline;">RULES OF ENGAGEMENT</h2>
                        <p><strong>Client:</strong> <?= htmlspecialchars($client) ?></p>
                        <p><strong>Method:</strong> <?= htmlspecialchars($scope_type) ?></p>
                        
                        <p><strong>Scope (Allowed Target):</strong></p>
                        <ul>
                            <?php foreach ($allowed as $a) echo "<li>" . htmlspecialchars($a) . "</li>"; ?>
                        </ul>
                        
                        <p><strong>Restrictions (Forbidden):</strong></p>
                        <ul>
                            <?php foreach ($forbidden as $f) echo "<li>" . htmlspecialchars($f) . "</li>"; ?>
                        </ul>
                        <br>
                        <p>With this document, the Client authorizes the Tester to perform security assessment within the agreed boundaries.</p>
                        <br><br>
                        
                        <div class="signature-box">
                            <div class="signature-line">
                                <strong>Signed by Tester</strong><br>
                                (<?= $_SESSION['username'] ?>)
                            </div>
                            <div class="signature-line">
                                <strong>Signed by Client</strong><br>
                                (PT. Maju Mundur)
                            </div>
                        </div>
                    </div>

                    <div style="margin-top: 2rem;">
                        <div class="alert alert-success">
                            <h3>âœ… Izin Diterima! Fase Eksekusi Dimulai.</h3>
                            <p>Berdasarkan kontrak di atas, Anda sekarang memiliki izin legal untuk menyerang target berikut. Silakan pilih target serangan:</p>
                        </div>

                        <div class="grid-2">
                            <!-- Target 1 -->
                            <a href="<?= $base_path ?>modules/info_gathering/index.php" class="card" style="text-decoration: none; border-left: 5px solid #6366f1; transition: transform 0.2s;">
                                <h4 style="color: var(--text);">ğŸ“¡ Tahap 2: Reconnaissance</h4>
                                <p style="color: var(--text-muted); font-size: 0.9rem;">Kumpulkan informasi target (Whois, DNS).</p>
                                <span class="btn btn-sm" style="margin-top:0.5rem">Start Recon &rarr;</span>
                            </a>

                            <!-- Target 2 -->
                            <a href="<?= $base_path ?>modules/sqli/index.php" class="card" style="text-decoration: none; border-left: 5px solid #ef4444; transition: transform 0.2s;">
                                <h4 style="color: var(--text);">ğŸ’‰ Tahap 3: Exploitation (SQLi)</h4>
                                <p style="color: var(--text-muted); font-size: 0.9rem;">Jebol halaman login bypass otentikasi.</p>
                                <span class="btn btn-sm" style="margin-top:0.5rem">Start Attack &rarr;</span>
                            </a>

                            <!-- Target 3 -->
                            <a href="<?= $base_path ?>modules/xss/index.php" class="card" style="text-decoration: none; border-left: 5px solid #f59e0b; transition: transform 0.2s;">
                                <h4 style="color: var(--text);">ğŸ“¢ Tahap 4: Client-Side (XSS)</h4>
                                <p style="color: var(--text-muted); font-size: 0.9rem;">Serang pengunjung lain via komentar.</p>
                                <span class="btn btn-sm" style="margin-top:0.5rem">Start Attack &rarr;</span>
                            </a>

                            <!-- Target 4 -->
                            <a href="<?= $base_path ?>modules/file_upload/index.php" class="card" style="text-decoration: none; border-left: 5px solid #10b981; transition: transform 0.2s;">
                                <h4 style="color: var(--text);">ğŸ“¤ Tahap 5: Get Shell (Upload)</h4>
                                <p style="color: var(--text-muted); font-size: 0.9rem;">Upload backdoor untuk kendali penuh.</p>
                                <span class="btn btn-sm" style="margin-top:0.5rem">Start Attack &rarr;</span>
                            </a>
                        </div>
                    </div>
                <?php endif; ?>
            <?php else: ?>
                <div class="alert alert-warning">
                    <h3>âš ï¸ Misi: Dapatkan Izin Hacking</h3>
                    <p><strong>Pentest Flow:</strong> Planning &rarr; Recon &rarr; Scanning &rarr; Exploitation &rarr; Reporting</p>
                    <p>Anda berada di tahap <strong>Planning</strong>. Web asli ini (Security Labs) memiliki banyak celah keamanan (SQLi, XSS, dll), tapi Anda tidak boleh menyerangnya sebelum membuat dokumen Scope ini.</p>
                </div>
            <?php endif; ?>
        </div>
    </div>
</div>

<?php include '../../includes/footer.php'; ?>
